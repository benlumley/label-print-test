<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Label Printer Test</title>
    <script src="https://cdn.jsdelivr.net/npm/qz-tray@2/qz-tray.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 540px;
            margin: 40px auto;
            padding: 0 20px;
            color: #1a1a1a;
            background: #f5f5f5;
        }
        h1 { font-size: 1.4rem; margin-bottom: 24px; }
        .field { margin-bottom: 14px; }
        .field label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 4px;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9rem;
            font-family: inherit;
            background: #fff;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4a90d9;
            box-shadow: 0 0 0 2px rgba(74, 144, 217, 0.2);
        }
        textarea {
            font-family: "SF Mono", "Fira Code", "Consolas", monospace;
            font-size: 0.8rem;
            line-height: 1.5;
            resize: vertical;
        }
        .row { display: flex; gap: 12px; }
        .row .field { flex: 1; }
        button {
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 10px 24px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 4px;
        }
        button:hover { background: #1d4ed8; }
        button:active { background: #1e40af; }
        button:disabled { background: #93c5fd; cursor: not-allowed; }
        .btn-secondary {
            background: #059669;
            margin-bottom: 10px;
        }
        .btn-secondary:hover { background: #047857; }
        .btn-secondary:disabled { background: #6ee7b7; }
        .btn-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-row button { margin-top: 0; }
        #status {
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            display: none;
        }
        #status.ok { display: block; background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        #status.err { display: block; background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        #status.info { display: block; background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .format-note {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
        }
        .connection-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            padding: 10px 14px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ef4444;
            flex-shrink: 0;
        }
        .dot.connected { background: #22c55e; }
        .connection-bar span { font-size: 0.85rem; color: #555; flex: 1; }
        .connection-bar button {
            width: auto;
            padding: 6px 14px;
            font-size: 0.8rem;
            margin: 0;
        }
        #printer-list {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 14px;
            padding: 8px 12px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            display: none;
            max-height: 120px;
            overflow-y: auto;
        }
        #printer-list div { padding: 2px 0; }
        #printer-list div.clickable {
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 3px;
        }
        #printer-list div.clickable:hover { background: #f0f0f0; }
    </style>
</head>
<body>
    <h1>Label Printer Test</h1>

    <div class="connection-bar">
        <div class="dot" id="conn-dot"></div>
        <span id="conn-text">Not connected to QZ Tray</span>
        <button id="conn-btn" onclick="toggleConnection()">Connect</button>
    </div>

    <div id="printer-list"></div>

    <div class="field">
        <label for="printer">Printer</label>
        <div class="row">
            <input type="text" id="printer" placeholder="Click 'Connect' then select a printer">
            <button style="width:auto; padding:6px 14px; font-size:0.8rem; white-space:nowrap; margin:0; flex-shrink:0;" onclick="listPrinters()">Find Printers</button>
        </div>
    </div>

    <div class="row">
        <div class="field">
            <label for="format">Format</label>
            <select id="format" onchange="loadTemplate()">
                <option value="zpl">ZPL (Zebra)</option>
                <option value="tpcl" selected>TPCL (Toshiba TEC)</option>
                <option value="epl">EPL2 (Eltron)</option>
                <option value="tspl">TSPL (TSC)</option>
                <option value="escpos">ESC/POS</option>
                <option value="raw">Raw Text</option>
            </select>
        </div>
    </div>

    <div class="field">
        <label for="data">Label Data</label>
        <textarea id="data" rows="14"></textarea>
        <div class="format-note" id="format-note"></div>
    </div>

    <button id="print-btn" onclick="sendPrint()">Send Test Print</button>
    <div id="status"></div>

    <script>
        const templates = {
            zpl: {
                data: `^XA

^FO50,30^A0N,40,40^FDLavandula angustifolia^FS
^FO50,80^A0N,28,28^FDEnglish Lavender^FS
^FO50,130^A0N,20,20^FDPerennial | Full Sun | Zone 5-9^FS
^FO50,170^BQN,2,4^FDQA,https://example.com/plant/123^FS

^XZ`,
                note: "Zebra Programming Language. Widely supported, including Toshiba TEC in ZPL emulation mode."
            },
            tpcl: {
                data: `\x1BiQ1\n\x1BiR1\n\x1BiM02\n\x1BiS0002\n\x1BPC000;0050,0030,2,2,C,00,B\nLavandula angustifolia\r\n\x1BPC000;0050,0080,2,2,C,00,B\nEnglish Lavender\r\n\x1BPC000;0050,0130,1,1,C,00,B\nPerennial | Full Sun | Zone 5-9\r\n\x1BXS;0050,0170,05,03,01\nhttps://example.com/plant/123\r\n\x1BQ1\n\x1BZ\n`,
                note: "Toshiba Printer Command Language. Native language for the SA4. Control characters are embedded directly."
            },
            epl: {
                data: `N
q812
Q1218,24
A50,30,0,4,1,1,N,"Lavandula angustifolia"
A50,80,0,3,1,1,N,"English Lavender"
A50,130,0,2,1,1,N,"Perennial | Full Sun | Zone 5-9"
b50,170,Q,s4,"https://example.com/plant/123"
P1`,
                note: "Eltron Programming Language. Used by older Zebra/Eltron printers."
            },
            tspl: {
                data: `SIZE 100 mm, 60 mm
GAP 3 mm, 0
CLS
TEXT 50,30,"4",0,1,1,"Lavandula angustifolia"
TEXT 50,80,"3",0,1,1,"English Lavender"
TEXT 50,130,"2",0,1,1,"Perennial | Full Sun | Zone 5-9"
QRCODE 50,170,L,4,A,0,"https://example.com/plant/123"
PRINT 1`,
                note: "TSC Printer Language. Used by TSC, Printronix, and some compatible printers."
            },
            escpos: {
                data: `\x1B@\x1Ba\x01\x1B!\x30Lavandula angustifolia\n\x1B!\x00\nEnglish Lavender\n\nPerennial | Full Sun | Zone 5-9\n\n\x1DV\x01`,
                note: "ESC/POS receipt/label format. Mostly for receipt printers but some label printers support it."
            },
            raw: {
                data: `Lavandula angustifolia
English Lavender
Perennial | Full Sun | Zone 5-9`,
                note: "Plain text. Useful for testing connectivity â€” printer should print the raw text if it accepts it."
            }
        };

        function loadTemplate() {
            const fmt = document.getElementById("format").value;
            const t = templates[fmt];
            document.getElementById("data").value = t.data;
            document.getElementById("format-note").textContent = t.note;
        }

        loadTemplate();

        function setStatus(msg, type) {
            const el = document.getElementById("status");
            el.textContent = msg;
            el.className = type;
        }

        function updateConnectionUI() {
            const connected = qz.websocket.isActive();
            document.getElementById("conn-dot").className = connected ? "dot connected" : "dot";
            document.getElementById("conn-text").textContent = connected ? "Connected to QZ Tray" : "Not connected to QZ Tray";
            document.getElementById("conn-btn").textContent = connected ? "Disconnect" : "Connect";
        }

        // Skip certificate validation for unsigned/self-compiled QZ Tray
        qz.security.setCertificatePromise(function(resolve, reject) {
            resolve();
        });
        qz.security.setSignatureAlgorithm("SHA512");
        qz.security.setSignaturePromise(function(toSign) {
            return function(resolve, reject) {
                resolve();
            };
        });

        async function toggleConnection() {
            const btn = document.getElementById("conn-btn");
            btn.disabled = true;

            try {
                if (qz.websocket.isActive()) {
                    await qz.websocket.disconnect();
                    document.getElementById("printer-list").style.display = "none";
                    setStatus("Disconnected.", "info");
                } else {
                    await qz.websocket.connect();
                    setStatus("Connected to QZ Tray.", "ok");
                    await listPrinters();
                }
            } catch (e) {
                setStatus("QZ Tray connection failed. Is QZ Tray running? " + e, "err");
            } finally {
                btn.disabled = false;
                updateConnectionUI();
            }
        }

        async function listPrinters() {
            if (!qz.websocket.isActive()) {
                setStatus("Connect to QZ Tray first.", "err");
                return;
            }

            try {
                const printers = await qz.printers.find();
                const listEl = document.getElementById("printer-list");

                if (printers.length === 0) {
                    listEl.innerHTML = "<div>No printers found.</div>";
                } else {
                    listEl.innerHTML = printers.map(p =>
                        `<div class="clickable" onclick="selectPrinter('${p.replace(/'/g, "\\'")}')">${p}</div>`
                    ).join("");
                }
                listEl.style.display = "block";
            } catch (e) {
                setStatus("Failed to list printers: " + e, "err");
            }
        }

        function selectPrinter(name) {
            document.getElementById("printer").value = name;
            document.getElementById("printer-list").style.display = "none";
            setStatus("Selected: " + name, "ok");
        }

        async function sendPrint() {
            const btn = document.getElementById("print-btn");
            const printerName = document.getElementById("printer").value.trim();
            const data = document.getElementById("data").value;

            if (!printerName) {
                setStatus("Select a printer first.", "err");
                return;
            }

            if (!qz.websocket.isActive()) {
                setStatus("Connect to QZ Tray first.", "err");
                return;
            }

            btn.disabled = true;
            btn.textContent = "Sending...";
            setStatus("Sending to " + printerName + "...", "info");

            try {
                const config = qz.configs.create(printerName, { altPrinting: true });
                await qz.print(config, [data]);
                setStatus("Sent successfully. Check the printer.", "ok");
            } catch (e) {
                setStatus("Print failed: " + e, "err");
            } finally {
                btn.disabled = false;
                btn.textContent = "Send Test Print";
            }
        }
    </script>
</body>
</html>
